<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qallow Mind Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Courier New', monospace;
            background: #0a0e27;
            color: #00ff88;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #00ff88;
            padding-bottom: 20px;
        }
        h1 {
            font-size: 2.5em;
            text-shadow: 0 0 10px #00ff88;
            margin-bottom: 10px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: #1a1f3a;
            border: 2px solid #00ff88;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
        }
        .card h2 {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #00ffff;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 4px;
        }
        .metric-label {
            font-weight: bold;
        }
        .metric-value {
            color: #ffff00;
            font-weight: bold;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #0a0e27;
            border: 1px solid #00ff88;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00ffff);
            transition: width 0.3s ease;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            background: #00ff88;
            color: #0a0e27;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }
        button:hover {
            background: #00ffff;
            box-shadow: 0 0 10px #00ffff;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.running {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff88;
        }
        .status.stopped {
            background: rgba(255, 0, 0, 0.2);
            color: #ff6666;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚ö° Qallow Mind Dashboard</h1>
            <p>Real-time Cognitive Pipeline Monitoring</p>
        </header>

        <div class="controls">
            <button onclick="startMind()">‚ñ∂ Start Mind</button>
            <button onclick="stopMind()">‚èπ Stop Mind</button>
            <button onclick="clearData()">üóë Clear Data</button>
        </div>

    <div id="status" class="status stopped">üî¥ Status: Stopped</div>

        <div class="grid">
            <!-- State Metrics -->
            <div class="card">
                <h2>üß† Cognitive State</h2>
                <div class="metric">
                    <span class="metric-label">Step:</span>
                    <span class="metric-value" id="step">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Reward:</span>
                    <span class="metric-value" id="reward">0.000</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="reward-bar" style="width: 0%"></div>
                </div>
                <div class="metric">
                    <span class="metric-label">Energy:</span>
                    <span class="metric-value" id="energy">0.500</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="energy-bar" style="width: 50%"></div>
                </div>
                <div class="metric">
                    <span class="metric-label">Risk:</span>
                    <span class="metric-value" id="risk">0.500</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="risk-bar" style="width: 50%"></div>
                </div>
            </div>

            <!-- Phase Status -->
            <div class="card">
                <h2>üìä Phase Status</h2>
                <div class="metric">
                    <span class="metric-label">Current Phase:</span>
                    <span class="metric-value" id="current-phase">Idle</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="phase-progress-bar" style="width: 0%"></div>
                </div>
                <div class="metric">
                    <span class="metric-label">Fidelity:</span>
                    <span class="metric-value" id="fidelity">0.000</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="fidelity-bar" style="width: 0%"></div>
                </div>
                <div class="metric">
                    <span class="metric-label">Coherence:</span>
                    <span class="metric-value" id="coherence">0.000</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="coherence-bar" style="width: 0%"></div>
                </div>
            </div>

            <!-- Ethics Scores -->
            <div class="card">
                <h2>‚öñÔ∏è Ethics Monitoring</h2>
                <div class="metric">
                    <span class="metric-label">Safety (S):</span>
                    <span class="metric-value" id="ethics-s">0.990</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="ethics-s-bar" style="width: 99%"></div>
                </div>
                <div class="metric">
                    <span class="metric-label">Clarity (C):</span>
                    <span class="metric-value" id="ethics-c">1.000</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="ethics-c-bar" style="width: 100%"></div>
                </div>
                <div class="metric">
                    <span class="metric-label">Human (H):</span>
                    <span class="metric-value" id="ethics-h">1.000</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="ethics-h-bar" style="width: 100%"></div>
                </div>
                <div class="metric" style="margin-top: 15px; font-size: 1.2em;">
                    <span class="metric-label">Total E:</span>
                    <span class="metric-value" id="ethics-total">2.990</span>
                </div>
            </div>

            <!-- System Info -->
            <div class="card">
                <h2>üìä System Info</h2>
                <div class="metric">
                    <span class="metric-label">Modules:</span>
                    <span class="metric-value" id="modules">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Telemetry Points:</span>
                    <span class="metric-value" id="telemetry-count">0</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Uptime:</span>
                    <span class="metric-value" id="uptime">0s</span>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid">
            <div class="card">
                <h2>üìà Reward Trajectory</h2>
                <div class="chart-container">
                    <canvas id="rewardChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2>‚ö° Energy & Risk</h2>
                <div class="chart-container">
                    <canvas id="energyRiskChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Audit Log -->
        <div class="card" style="margin-top: 20px;">
            <h2>üìã Ethics Audit Log</h2>
            <div id="audit-log" style="max-height: 300px; overflow-y: auto; background: rgba(0, 255, 136, 0.05); padding: 10px; border-radius: 4px; font-size: 0.9em;">
                <p style="color: #888;">Loading audit log...</p>
            </div>
        </div>

        <!-- Phase Metrics -->
        <div class="card" style="margin-top: 20px;">
            <h2>üìä Phase Metrics</h2>
            <div id="phase-metrics" style="max-height: 400px; overflow-y: auto;">
                <p style="color: #888;">Loading phase data...</p>
            </div>
        </div>
    </div>

    <script>
        let rewardChart, energyRiskChart;
        let startTime = null;

        const clamp = (value, min = 0, max = 1) => {
            const numeric = Number.isFinite(value) ? value : 0;
            return Math.min(Math.max(numeric, min), max);
        };

        async function updateDashboard() {
            try {
                const [state, telemetry, ethics, phases, audit] = await Promise.all([
                    fetch('/api/state').then(r => r.json()),
                    fetch('/api/telemetry').then(r => r.json()),
                    fetch('/api/ethics').then(r => r.json()),
                    fetch('/api/phases').then(r => r.json()),
                    fetch('/api/audit').then(r => r.json()),
                ]);

                const telemetryData = Array.isArray(telemetry) ? telemetry : [];
                const phaseData = phases && typeof phases === 'object' ? phases : {};
                const auditEntries = audit && Array.isArray(audit.entries) ? audit.entries : [];

                document.getElementById('step').textContent = state.step ?? 0;
                document.getElementById('reward').textContent = (state.reward ?? 0).toFixed(3);
                document.getElementById('energy').textContent = (state.energy ?? 0.5).toFixed(3);
                document.getElementById('risk').textContent = (state.risk ?? 0.5).toFixed(3);
                document.getElementById('modules').textContent = state.modules ?? 0;
                document.getElementById('telemetry-count').textContent = telemetryData.length;

                document.getElementById('reward-bar').style.width = `${clamp(state.reward) * 100}%`;
                document.getElementById('energy-bar').style.width = `${clamp(state.energy) * 100}%`;
                document.getElementById('risk-bar').style.width = `${clamp(state.risk) * 100}%`;

                document.getElementById('current-phase').textContent = state.current_phase || 'Idle';
                document.getElementById('phase-progress-bar').style.width = `${clamp(state.phase_progress) * 100}%`;
                document.getElementById('fidelity').textContent = (state.fidelity ?? 0).toFixed(3);
                document.getElementById('fidelity-bar').style.width = `${clamp(state.fidelity) * 100}%`;
                document.getElementById('coherence').textContent = (state.coherence ?? 0).toFixed(3);
                document.getElementById('coherence-bar').style.width = `${clamp(state.coherence) * 100}%`;

                const safeEthics = {
                    safety: Number.isFinite(ethics && ethics.safety) ? ethics.safety : 0.99,
                    clarity: Number.isFinite(ethics && ethics.clarity) ? ethics.clarity : 1.0,
                    human: Number.isFinite(ethics && ethics.human) ? ethics.human : 1.0,
                };
                safeEthics.total = Number.isFinite(ethics && ethics.total)
                    ? ethics.total
                    : safeEthics.safety + safeEthics.clarity + safeEthics.human;

                document.getElementById('ethics-s').textContent = safeEthics.safety.toFixed(3);
                document.getElementById('ethics-c').textContent = safeEthics.clarity.toFixed(3);
                document.getElementById('ethics-h').textContent = safeEthics.human.toFixed(3);
                document.getElementById('ethics-total').textContent = safeEthics.total.toFixed(3);
                document.getElementById('ethics-s-bar').style.width = `${clamp(safeEthics.safety) * 100}%`;
                document.getElementById('ethics-c-bar').style.width = `${clamp(safeEthics.clarity) * 100}%`;
                document.getElementById('ethics-h-bar').style.width = `${clamp(safeEthics.human) * 100}%`;

                const statusEl = document.getElementById('status');
                if (state.running) {
                    statusEl.className = 'status running';
                    statusEl.textContent = 'üü¢ Status: Running';
                    if (!startTime) startTime = Date.now();
                } else {
                    statusEl.className = 'status stopped';
                    statusEl.textContent = 'üî¥ Status: Stopped';
                    startTime = null;
                }

                if (startTime) {
                    const uptime = Math.floor((Date.now() - startTime) / 1000);
                    document.getElementById('uptime').textContent = `${uptime}s`;
                } else {
                    document.getElementById('uptime').textContent = '0s';
                }

                updateAuditLog(auditEntries);
                updatePhaseMetrics(phaseData);
                updateCharts(telemetryData);
            } catch (e) {
                console.error('Update error:', e);
            }
        }

        function updateAuditLog(entries) {
            const logEl = document.getElementById('audit-log');
            if (!entries || entries.length === 0) {
                logEl.innerHTML = '<p style="color: #888;">No audit entries</p>';
                return;
            }
            logEl.innerHTML = entries.map(entry =>
                `<div style="padding: 5px; border-bottom: 1px solid rgba(0, 255, 136, 0.2);">${entry}</div>`
            ).join('');
        }

        function updatePhaseMetrics(phases) {
            const metricsEl = document.getElementById('phase-metrics');
            if (!phases || Object.keys(phases).length === 0) {
                metricsEl.innerHTML = '<p style="color: #888;">No phase data available</p>';
                return;
            }

            let html = '';
            for (const [phaseName, phaseData] of Object.entries(phases)) {
                const latest = phaseData.latest || {};
                html += `
                    <div style="margin-bottom: 15px; padding: 10px; background: rgba(0, 255, 136, 0.05); border-radius: 4px;">
                        <div style="font-weight: bold; color: #00ffff;">${phaseName}</div>
                        <div style="font-size: 0.9em; margin-top: 5px;">
                            ${latest.coherence !== undefined ? `Coherence: ${latest.coherence.toFixed(3)}` : ''}
                            ${latest.fidelity !== undefined ? ` | Fidelity: ${latest.fidelity.toFixed(3)}` : ''}
                            ${latest.tick !== undefined ? ` | Tick: ${latest.tick}` : ''}
                        </div>
                    </div>
                `;
            }
            metricsEl.innerHTML = html;
        }

        function updateCharts(telemetry) {
            if (!Array.isArray(telemetry) || telemetry.length === 0) {
                if (rewardChart) {
                    rewardChart.destroy();
                    rewardChart = null;
                }
                if (energyRiskChart) {
                    energyRiskChart.destroy();
                    energyRiskChart = null;
                }
                return;
            }

            const steps = telemetry.map(t => t.step);
            const rewards = telemetry.map(t => t.reward);
            const energies = telemetry.map(t => t.energy);
            const risks = telemetry.map(t => t.risk);

            if (!rewardChart) {
                const ctx1 = document.getElementById('rewardChart').getContext('2d');
                rewardChart = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: steps,
                        datasets: [{
                            label: 'Reward',
                            data: rewards,
                            borderColor: '#ffff00',
                            backgroundColor: 'rgba(255, 255, 0, 0.1)',
                            tension: 0.4,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { labels: { color: '#00ff88' } } },
                        scales: {
                            y: { ticks: { color: '#00ff88' }, grid: { color: 'rgba(0, 255, 136, 0.1)' } },
                            x: { ticks: { color: '#00ff88' }, grid: { color: 'rgba(0, 255, 136, 0.1)' } }
                        }
                    }
                });
            } else {
                rewardChart.data.labels = steps;
                rewardChart.data.datasets[0].data = rewards;
                rewardChart.update();
            }

            if (!energyRiskChart) {
                const ctx2 = document.getElementById('energyRiskChart').getContext('2d');
                energyRiskChart = new Chart(ctx2, {
                    type: 'line',
                    data: {
                        labels: steps,
                        datasets: [
                            {
                                label: 'Energy',
                                data: energies,
                                borderColor: '#00ff88',
                                backgroundColor: 'rgba(0, 255, 136, 0.1)',
                                tension: 0.4,
                            },
                            {
                                label: 'Risk',
                                data: risks,
                                borderColor: '#ff6666',
                                backgroundColor: 'rgba(255, 102, 102, 0.1)',
                                tension: 0.4,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { labels: { color: '#00ff88' } } },
                        scales: {
                            y: { ticks: { color: '#00ff88' }, grid: { color: 'rgba(0, 255, 136, 0.1)' } },
                            x: { ticks: { color: '#00ff88' }, grid: { color: 'rgba(0, 255, 136, 0.1)' } }
                        }
                    }
                });
            } else {
                energyRiskChart.data.labels = steps;
                energyRiskChart.data.datasets[0].data = energies;
                energyRiskChart.data.datasets[1].data = risks;
                energyRiskChart.update();
            }
        }

        function resetDashboardUI() {
            startTime = null;
            const defaults = {
                step: '0',
                reward: '0.000',
                energy: '0.500',
                risk: '0.500',
                modules: '0',
                'telemetry-count': '0',
                uptime: '0s',
                'current-phase': 'Idle',
                fidelity: '0.000',
                coherence: '0.000',
                'ethics-s': '0.990',
                'ethics-c': '1.000',
                'ethics-h': '1.000',
                'ethics-total': '2.990',
            };

            Object.entries(defaults).forEach(([id, value]) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            });

            const widths = {
                'reward-bar': '0%',
                'energy-bar': '50%',
                'risk-bar': '50%',
                'phase-progress-bar': '0%',
                'fidelity-bar': '0%',
                'coherence-bar': '0%',
                'ethics-s-bar': '99%',
                'ethics-c-bar': '100%',
                'ethics-h-bar': '100%',
            };

            Object.entries(widths).forEach(([id, value]) => {
                const el = document.getElementById(id);
                if (el) el.style.width = value;
            });

            const statusEl = document.getElementById('status');
            if (statusEl) {
                statusEl.className = 'status stopped';
                statusEl.textContent = 'üî¥ Status: Stopped';
            }

            if (rewardChart) {
                rewardChart.destroy();
                rewardChart = null;
            }
            if (energyRiskChart) {
                energyRiskChart.destroy();
                energyRiskChart = null;
            }

            const auditEl = document.getElementById('audit-log');
            if (auditEl) {
                auditEl.innerHTML = '<p style="color: #888;">No audit entries</p>';
            }

            const phaseMetricsEl = document.getElementById('phase-metrics');
            if (phaseMetricsEl) {
                phaseMetricsEl.innerHTML = '<p style="color: #888;">No phase data available</p>';
            }
        }

        async function startMind() {
            try {
                const response = await fetch('/api/start', { method: 'POST' });
                const payload = await response.json().catch(() => ({}));
                if (response.ok && payload.status === 'started') {
                    startTime = Date.now();
                }
            } catch (err) {
                console.error('Start mind error:', err);
            }
        }

        async function stopMind() {
            try {
                await fetch('/api/stop', { method: 'POST' });
            } catch (err) {
                console.error('Stop mind error:', err);
            }
            startTime = null;
        }

        async function clearData() {
            try {
                const response = await fetch('/api/clear', { method: 'POST' });
                const payload = await response.json().catch(() => ({}));
                if (response.ok && payload.status === 'cleared') {
                    resetDashboardUI();
                    await updateDashboard();
                } else if (response.status === 409) {
                    console.warn('Cannot clear data while mind is running.');
                }
            } catch (err) {
                console.error('Clear data error:', err);
            }
        }

        // Update every 500ms
        setInterval(updateDashboard, 500);
        updateDashboard();
    </script>
</body>
</html>

