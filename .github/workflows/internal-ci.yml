name: Qallow Internal CI

on:
  push:
    branches:
      - main
      - develop
      - release/**
  pull_request:

jobs:
  build-and-test:
    name: Build and Accelerator Smoke
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          # Remove unnecessary files to free up space
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /opt/hostedtoolcache || true
          df -h

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            build-essential \
            gcc \
            g++ \
            make \
            git \
            wget \
            curl \
            python3-dev \
            python3-pip
          # Upgrade pip and setuptools
          python3 -m pip install --upgrade pip setuptools wheel --no-cache-dir
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

      - name: Verify Python and pip
        run: |
          python3 --version
          python3 -m pip --version

      - name: Install CUDA toolkit
        continue-on-error: true
        run: |
          # Download and install CUDA 13.0 toolkit (optional for CPU builds)
          echo "Attempting to install CUDA 13.0 toolkit..."
          wget -q https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb || {
            echo "Warning: Failed to download CUDA keyring, skipping CUDA installation"
            exit 0
          }
          sudo dpkg -i cuda-keyring_1.1-1_all.deb || true
          sudo apt-get update || true
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            cuda-toolkit-13-0 \
            cuda-nsight-compute-13-0 || {
            echo "Warning: CUDA installation failed, continuing without it"
            exit 0
          }
          # Add CUDA to PATH
          echo "/usr/local/cuda-13.0/bin" >> $GITHUB_PATH
          echo "LD_LIBRARY_PATH=/usr/local/cuda-13.0/lib64:$LD_LIBRARY_PATH" >> $GITHUB_ENV
          sudo apt-get clean || true
          sudo rm -rf /var/lib/apt/lists/* || true

      - name: Check Makefile source coverage
        run: python3 scripts/check_makefile_sources.py

      - name: Pre-build cleanup
        run: bash scripts/pre_build_cleanup.sh

      - name: Configure and build (CPU)
        run: |
          set -eux
          # Clean previous configure cache (if any)
          rm -rf build/CPU
          # Configure explicitly with QALLOW_ENABLE_CUDA=OFF
          cmake -S . -B build/CPU -DQALLOW_ENABLE_CUDA=OFF -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          # Show generated files right after configure
          echo "After configure:"
          ls -la build/CPU || true
          # Build with verbose output into a log file
          cmake --build build/CPU -- -j"$(nproc)" VERBOSE=1 2>&1 | tee build/CPU/build.log || (echo "Build failed - see build/CPU/build.log" && tail -n 200 build/CPU/build.log && false)
          # Show produced artifacts and search for likely binaries
          echo "After build:"
          ls -la build/CPU || true
          find build/CPU -maxdepth 4 -type f -executable -print -ls || true
          # Print last 200 lines of the build log to the job log
          tail -n 200 build/CPU/build.log || true

      - name: Verify binary exists
        run: |
          set -eux
          echo "Listing build/CPU:"
          ls -la build/CPU || true
          echo "Searching for qallow-related executables:"
          find build/CPU -maxdepth 4 -type f -perm /u=x,g=x,o=x -name "*qallow*" -print -ls || true
          if [ -f build/CPU/qallow_unified_cpu ]; then
            echo "Binary verified: $(file build/CPU/qallow_unified_cpu)"
            exit 0
          fi
          echo "ERROR: Expected binary build/CPU/qallow_unified_cpu not found."
          echo "See build/CPU/build.log for build output (if present)."
          exit 1

      - name: Run smoke tests
        env:
          QALLOW_SKIP_BUILD_ONCE: "1"
        run: |
          echo "Running smoke tests..."
          bash tests/smoke/test_modules.sh || {
            echo "Smoke tests failed"
            exit 1
          }

      - name: Accelerator execution
        env:
          QALLOW_QUIET: "1"
          QALLOW_SKIP_BUILD_ONCE: "1"
        run: |
          echo "{}" > /tmp/accelerator_input.json
          ./build/CPU/qallow_unified_cpu run --accelerator --file=/tmp/accelerator_input.json --no-watch --threads=2 --quiet

      - name: Clean up build artifacts
        if: always()
        run: |
          rm -rf build/
          df -h

      - name: Build Rust unified project
        run: |
          echo "Building Rust unified project..."
          cargo build --release
          echo "Rust build completed successfully"

      - name: Dependency report
        continue-on-error: true
        run: scripts/check_dependencies.sh
