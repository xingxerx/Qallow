#!/bin/bash
# Qallow Unified Command Interface
# Handles all VM operations

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Directories
CPU_DIR="backend/cpu"
CUDA_DIR="backend/cuda"
INC_DIR="core/include"
INTERFACE_DIR="interface"
BUILD_DIR="build"
OUTPUT="qallow_phase4"

# CUDA architecture (override with SM=sm_89 make-style)
SM="${SM:-sm_89}"

show_help() {
    echo -e "${BLUE}Qallow - Unified Command Interface${NC}"
    echo ""
    echo "Usage: ./qallow <command>"
    echo ""
    echo "Commands:"
    echo "  build      Build both CPU + CUDA"
    echo "  run        Execute VM"
    echo "  bench      Run benchmark"
    echo "  govern     Run governance audit"
    echo "  visual     Open live dashboard"
    echo "  verify     System verification"
    echo "  live       Live data integration"
    echo "  clean      Remove build artifacts"
    echo "  help       Show this help"
    echo ""
    echo "Environment Variables:"
    echo "  SM            CUDA architecture (default: sm_89)"
    echo "                Examples: sm_86 (Ampere), sm_89 (Ada), sm_90 (Hopper)"
    echo "  QALLOW_LOG    CSV log file path (e.g., QALLOW_LOG=data.csv ./qallow run)"
    echo ""
    echo "Examples:"
    echo "  ./qallow build                    # Build with default sm_89"
    echo "  SM=sm_86 ./qallow build          # Build for Ampere (RTX 30xx)"
    echo "  QALLOW_LOG=run.csv ./qallow run  # Run with CSV logging"
    echo ""
}

cmd_build() {
    echo -e "${BLUE}================================${NC}"
    echo -e "${BLUE}Building Qallow VM${NC}"
    echo -e "${BLUE}================================${NC}"
    echo ""
    
    # Check for CUDA
    if ! command -v nvcc &> /dev/null; then
        echo -e "${RED}Error: nvcc not found${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}[INFO]${NC} CUDA: $(nvcc --version | grep release | awk '{print $5}' | tr -d ',')"
    echo -e "${GREEN}[INFO]${NC} GCC: $(gcc --version | head -n1 | awk '{print $3}')"
    echo -e "${GREEN}[INFO]${NC} Architecture: $SM"
    echo ""
    
    # Create build directory
    mkdir -p $BUILD_DIR
    
    # Check source files
    if [ ! -f "$CPU_DIR/qallow_kernel.c" ]; then
        echo -e "${RED}Error: Source files not found in $CPU_DIR${NC}"
        exit 1
    fi
    
    echo -e "${BLUE}[1/3] Compiling CPU modules...${NC}"
    for src in $CPU_DIR/*.c; do
        if [ -f "$src" ]; then
            obj="$BUILD_DIR/$(basename $src .c).o"
            echo -e "${GREEN}  →${NC} $(basename $src)"
            gcc -O2 -Wall -I$INC_DIR -DCUDA_ENABLED=1 -c "$src" -o "$obj" || exit 1
        fi
    done
    
    echo ""
    echo -e "${BLUE}[2/3] Compiling CUDA kernels...${NC}"
    for src in $CUDA_DIR/*.cu; do
        if [ -f "$src" ]; then
            obj="$BUILD_DIR/$(basename $src .cu)_cu.o"
            echo -e "${GREEN}  →${NC} $(basename $src)"
            nvcc -O2 -arch=$SM -std=c++14 -I$INC_DIR -DCUDA_ENABLED=1 -c "$src" -o "$obj" || exit 1
        fi
    done
    
    # Compile interface files
    echo ""
    echo -e "${BLUE}[2.5/3] Compiling interface...${NC}"
    for src in interface/*.c; do
        if [ -f "$src" ]; then
            obj="$BUILD_DIR/$(basename $src .c).o"
            echo -e "${GREEN}  →${NC} $(basename $src)"
            gcc -O2 -Wall -I$INC_DIR -DCUDA_ENABLED=1 -c "$src" -o "$obj" || exit 1
        fi
    done
    
    echo ""
    echo -e "${BLUE}[3/3] Linking...${NC}"
    OBJ_FILES=$(find $BUILD_DIR -name "*.o")
    nvcc -o $OUTPUT $OBJ_FILES -lcurand -lm || exit 1
    
    echo ""
    echo -e "${GREEN}================================${NC}"
    echo -e "${GREEN}BUILD SUCCESSFUL${NC}"
    echo -e "${GREEN}================================${NC}"
    echo ""
    echo -e "Executable: ${YELLOW}$OUTPUT${NC}"
    echo ""
}

cmd_run() {
    if [ ! -f "$OUTPUT" ]; then
        echo -e "${RED}Error: $OUTPUT not found. Run './qallow build' first.${NC}"
        exit 1
    fi
    
    echo -e "${BLUE}Running Qallow VM...${NC}"
    echo ""
    ./$OUTPUT "$@"
}

cmd_bench() {
    echo -e "${BLUE}Running benchmark...${NC}"
    if [ -f "$OUTPUT" ]; then
        ./$OUTPUT bench
    else
        echo -e "${RED}Error: $OUTPUT not found. Run './qallow build' first.${NC}"
        exit 1
    fi
}

cmd_govern() {
    echo -e "${BLUE}Running governance audit...${NC}"
    if [ -f "$OUTPUT" ]; then
        ./$OUTPUT govern
    else
        echo -e "${RED}Error: $OUTPUT not found. Run './qallow build' first.${NC}"
        exit 1
    fi
}

cmd_visual() {
    echo -e "${BLUE}Opening dashboard...${NC}"
    if [ -f "$OUTPUT" ]; then
        ./$OUTPUT visual
    else
        echo -e "${RED}Error: $OUTPUT not found. Run './qallow build' first.${NC}"
        exit 1
    fi
}

cmd_verify() {
    echo -e "${BLUE}Running system verification...${NC}"
    if [ -f "$OUTPUT" ]; then
        ./$OUTPUT verify
    else
        echo -e "${RED}Error: $OUTPUT not found. Run './qallow build' first.${NC}"
        exit 1
    fi
}

cmd_live() {
    echo -e "${BLUE}Starting live interface...${NC}"
    if [ -f "$OUTPUT" ]; then
        ./$OUTPUT live
    else
        echo -e "${RED}Error: $OUTPUT not found. Run './qallow build' first.${NC}"
        exit 1
    fi
}

cmd_clean() {
    echo -e "${YELLOW}Cleaning build artifacts...${NC}"
    rm -rf $BUILD_DIR
    rm -f $OUTPUT
    rm -f *.csv *.txt
    echo -e "${GREEN}Clean complete.${NC}"
}

# Main command dispatcher
case "$1" in
    build)
        cmd_build
        ;;
    run)
        shift
        cmd_run "$@"
        ;;
    bench)
        cmd_bench
        ;;
    govern)
        cmd_govern
        ;;
    visual)
        cmd_visual
        ;;
    verify)
        cmd_verify
        ;;
    live)
        cmd_live
        ;;
    clean)
        cmd_clean
        ;;
    help|--help|-h|"")
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo ""
        show_help
        exit 1
        ;;
esac
